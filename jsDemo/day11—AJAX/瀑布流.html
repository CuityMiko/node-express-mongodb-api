<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>瀑布流</title>
		<style>
			*{margin: 0;padding: 0;}
			div{margin: 10px auto;position: relative;}
		</style>
	</head>
	<body>
		<div id="divBox"></div>
		<script>
			//列定宽
			var oImgWidth=300;
			//窗口可视宽
			var clientWidth=document.documentElement.clientWidth||document.body.clientWidth;
			//最小列数
			var cloumnMin=2;
			//最大列数
			var cloumnMax=6;
			//列数
			var cloumn=Math.min(Math.max(Math.floor(clientWidth/oImgWidth),cloumnMin),cloumnMax);
			//创建div居中
			var oDiv=document.getElementById("divBox");
			oDiv.style.width=cloumn*oImgWidth+"px";
			//记录每列的高度
			var arrCloumn=[];
			for(var i=0;i<cloumn;i++){
				arrCloumn[i]=0;
			}
			//记录高度最小列的下标
			var indexMin;
			//记录高度最大列的下标
			var indexMax;
			
			//记录页数
			var pageIndex=1;
			
			ajax(1);
			
			window.onscroll=function(){
				var clientHeight=document.documentElement.clientHeight||document.body.clientHeight;
				var scrollTop=document.documentElement.scrollTop||document.body.scrollTop;
				indexMax=getMaxIndex(arrCloumn);
				if(arrCloumn[indexMax]<=clientHeight+scrollTop+10){
					pageIndex++;
					ajax(pageIndex);
				}
			}
			
			window.onresize=function(){
				var clientWidth=document.documentElement.clientWidth||document.body.clientWidth;
				var cloumnNew=Math.floor(clientWidth/oImgWidth);
				//当新的列数和旧的列数不一致时，才对页面的图片进行重新布局
				if(cloumnNew!=cloumn&&cloumnNew>=cloumnMin&&cloumnNew<=cloumnMax){
					cloumn=cloumnNew;
					//1.拿到图片
					var arrImg=oDiv.getElementsByTagName("img");
					//2.将记录高度的数组清空
					arrCloumn=[];
					for(var i=0;i<cloumnNew;i++){
						arrCloumn[i]=0;
					}
					for(var j=0;j<arrImg.length;j++){
						indexMin=getMinIndex(arrCloumn);
						arrImg[j].style.left=indexMin*oImgWidth+"px";
						arrImg[j].style.top=arrCloumn[indexMin]+"px";
						arrCloumn[indexMin]+=arrImg[j].offsetHeight;
					}
				}
			}
			
			function ajax(i){
				var xhr;
				if(window.XMLHttpRequest){
					xhr=new XMLHttpRequest();
				}
				else{
					xhr=new ActiveXObject("Micorsoft.XMLHTTP");
				}
				xhr.onreadystatechange=function(){
					if(xhr.readyState==4){
						if(xhr.status==200){
							var result=xhr.responseText;
							addImgData(result);
						}
						else{
							
						}
					}
				}
				xhr.open("get","data/imgdata"+i+".json");
				xhr.send();
			}
			
			function addImgData(result){
				var oData=eval("("+result+")");
				for(var i=0;i<oData.length;i++){
					var oImg=document.createElement("img");
					oImg.style.width=oImgWidth+"px";
					oImg.style.height=oData[i].height+"px";
					oImg.src="img/"+oData[i].url;
					oImg.style.position="absolute";
					indexMin=getMinIndex(arrCloumn);
					oImg.style.left=indexMin*oImgWidth+"px";
					oImg.style.top=arrCloumn[indexMin]+"px";
					oDiv.appendChild(oImg);
					arrCloumn[indexMin]+=oData[i].height;
				}
			}
			
			function getMinIndex(arr){
				var index=0;
				for(var i=1;i<arr.length;i++){
					if(arr[index]>arr[i]){
						index=i;
					}
				}
				return index;
			}
			
			function getMaxIndex(arr){
				var index=0;
				for(var i=1;i<arr.length;i++){
					if(arr[index]<arr[i]){
						index=i;
					}
				}
				return index;
			}
			
		</script>
	</body>
</html>
